# =============================================================================
# Local Infrastructure for Kairos Workshop (MacOS)
# =============================================================================
# This compose file provides local alternatives to GitHub and container registries
# for running the Kairos workshop entirely on MacOS.
#
# Services:
#   - gitea: Local Git server (replaces GitHub)
#   - registry: Local container registry (replaces ttl.sh/quay.io)
#
# Data is stored locally in ./data/ for easy inspection and backup.
#
# Usage:
#   docker compose up -d
#   # or with Podman:
#   podman-compose up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Gitea - Local Git Server
  # ---------------------------------------------------------------------------
  # Web UI: http://localhost:3000
  # Git SSH: localhost:2222
  # Data: ./data/gitea/
  # ---------------------------------------------------------------------------
  gitea:
    image: docker.gitea.com/gitea:1.25.4-rootless
    container_name: kairos-gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - USER=git
      - GITEA__server__ROOT_URL=http://localhost:3000
      - GITEA__server__HTTP_PORT=3000
      - GITEA__server__SSH_PORT=2222
      - GITEA__server__SSH_LISTEN_PORT=2222
      - GITEA__service__DISABLE_REGISTRATION=false
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=kairos-gitea-db:3306
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea
    volumes:
      - gitea-data:/data
      - gitea-config:/etc/gitea
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "2222:2222"
    restart: unless-stopped

  gitea-db:
    image: docker.io/mysql:8
    container_name: kairos-gitea-db
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=gitea
      - MYSQL_USER=gitea
      - MYSQL_PASSWORD=gitea
      - MYSQL_DATABASE=gitea
    volumes:
      - mysql-data:/var/lib/mysql

  # ---------------------------------------------------------------------------
  # Registry - Local Container Registry
  # ---------------------------------------------------------------------------
  # Push: podman push --tls-verify=false localhost:5000/kairos-custom:latest
  # Pull: podman pull --tls-verify=false localhost:5000/kairos-custom:latest
  # Data: ./data/registry/
  # ---------------------------------------------------------------------------
  registry:
    image: registry:2
    container_name: kairos-registry
    environment:
      - REGISTRY_HTTP_ADDR=0.0.0.0:5000
      - REGISTRY_STORAGE_DELETE_ENABLED=true
    volumes:
      - ./data/registry:/var/lib/registry
    ports:
      - "5000:5000"
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Registry UI (Optional) - Browse registry contents
  # ---------------------------------------------------------------------------
  # Web UI: http://localhost:8080
  # ---------------------------------------------------------------------------
  registry-ui:
    image: joxit/docker-registry-ui:main
    container_name: kairos-registry-ui
    environment:
      - SINGLE_REGISTRY=true
      - REGISTRY_TITLE=Kairos Workshop Registry
      - REGISTRY_URL=http://registry:5000
      - DELETE_IMAGES=true
    ports:
      - "8080:80"
    depends_on:
      - registry
    restart: unless-stopped
volumes:
  gitea-data:
    driver: local
  gitea-config:
    driver: local
  mysql-data:
    driver: local

networks:
  kairos:
    driver: bridge